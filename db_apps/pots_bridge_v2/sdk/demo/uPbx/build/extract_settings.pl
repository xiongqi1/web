#!/usr/bin/perl
#
# Copyright 2013-2015, Silicon Labs
#
# $Id: extract_settings.pl 6226 2017-01-17 00:50:52Z nizajerk $
use File::Basename;

sub parse_fn
{
    my($filename) = @_;

    my($output_dir, $is_fxs);
    $output_dir = "../src/autogen/";

		if(!(-d $output_dir))
		{
			mkdir $output_dir;
		}

    # Code assumes RING, DCFEED, Impedance, FSK, PULSE METER,
    # TONE and PCM in that order... change section names if this 
    # changes...

    @fxs_section_names = ("Ring", "DcFeed","Impedance", "FSK", "PulseMeter", "Tone", "PCM");
    @fxo_section_names = ("Vdaa_country", "Vdaa_audioGain","Vdaa_ringDetect", "Vdaa_PCM", "Vdaa_hybrid");

    my($config_state, $in_enum);

    open(INPUT_FH,  "<", $filename) or die $!;
    
    $config_state = 0;
    $in_enum = 0;

    while(<INPUT_FH>)
    {
        chomp $_;

        if(/^enum/)
        {
            $config_state += 1;
            $in_enum = 1;
            if($is_fxs)
            {
              printf OUTPUT_FH "const char *%s_preset_options[] =\n{\n",@fxs_section_names[$config_state-1];
            }
            else
            {
              printf OUTPUT_FH "const char *%s_preset_options[] =\n{\n",@fxo_section_names[$config_state-1];
            }
        }
        elsif (/\};/)
        {
            print OUTPUT_FH "\tNULL\n};\n\n";
            $in_enum = 0;
        }
        elsif($config_state && $in_enum && /\W+(\w*),*/)
        {
						$enum_name = $1;
						if(/.*,/)
						{
            	printf OUTPUT_FH "\t\"%s\",\n", $enum_name;
						}
        }
        elsif(/.+define\W+SI3([0-9X]+)_CONSTANTS_H/)
        {
            $chipset = "si3".lc($1);
            #print "Chipset =",$chipset,"\n";
            open(OUTPUT_FH, ">", $output_dir.$chipset."_options.".c) or die $!;
            print OUTPUT_FH "/* Copyright 2015, Silicon Labs */\n";
            print OUTPUT_FH "/* Autogenerated file - do not modify */\n\n";

            print OUTPUT_FH "#include <stdlib.h>\n";
            print OUTPUT_FH "#include \"",basename($filename),"\"\n\n";
            $is_fxs = 1;
        }
        elsif(/.+define\W+VDAA_CONSTANTS_H/)
        {
          $chipset= "si3050";
          open(OUTPUT_FH, ">", $output_dir.$chipset."_options.".c) or die $!;
          print OUTPUT_FH "/* Copyright 2015, Silicon Labs */\n";
          print OUTPUT_FH "/* Autogenerated file - do not modify */\n\n";

          print OUTPUT_FH "#include <stdlib.h>\n";
          print OUTPUT_FH "#include \"",basename($filename),"\"\n\n";
          $is_fxs=0;
        }
    }
    close INPUT_FH;
    close OUTPUT_FH;
}

for my $args (@ARGV)
{
    parse_fn($args);
}

